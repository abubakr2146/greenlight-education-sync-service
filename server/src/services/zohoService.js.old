const axios = require('axios');
const { loadZohoConfig, saveZohoConfig, filterIgnoredFields, FIELD_MAPPING } = require('../config/config');
const { getZohoModulePluralName } = require('./moduleConfigService');

// Refresh Zoho access token
async function refreshZohoToken(config) {
  try {
    const response = await axios.post('https://accounts.zoho.com/oauth/v2/token', null, {
      params: {
        refresh_token: config.refreshToken,
        client_id: config.clientId,
        client_secret: config.clientSecret,
        grant_type: 'refresh_token'
      }
    });
    
    config.accessToken = response.data.access_token;
    config.tokenExpiry = Date.now() + (response.data.expires_in * 1000);
    
    // Save the updated config
    const saved = saveZohoConfig(config);
    if (!saved) {
      return false;
    }
    
    return true;
  } catch (error) {
    return false;
  }
}

// Fetch record details from Zoho with automatic token refresh (module-aware)
async function getRecordDetails(recordId, module = 'Leads', config = null) {
  if (!config) {
    config = loadZohoConfig();
    if (!config) {
      return null;
    }
  }

  try {
    // Check if token needs refresh
    if (Date.now() >= config.tokenExpiry) {
      const refreshed = await refreshZohoToken(config);
      if (!refreshed) {
        return null;
      }
    }
    
    const modulePlural = getZohoModulePluralName(module);
    const response = await axios.get(
      `${config.apiDomain}/crm/v2/${modulePlural}/${recordId}`,
      {
        headers: {
          'Authorization': `Zoho-oauthtoken ${config.accessToken}`,
          'Content-Type': 'application/json'
        }
      }
    );
    return response.data;
  } catch (error) {
    // If token is invalid, try refreshing once
    if (error.response?.data?.code === 'INVALID_TOKEN') {
      const refreshed = await refreshZohoToken(config);
      if (refreshed) {
        // Retry the request with new token
        try {
          const modulePlural = getZohoModulePluralName(module);
          const response = await axios.get(
            `${config.apiDomain}/crm/v2/${modulePlural}/${recordId}`,
            {
              headers: {
                'Authorization': `Zoho-oauthtoken ${config.accessToken}`,
                'Content-Type': 'application/json'
              }
            }
          );
          return response.data;
        } catch (retryError) {
          return null;
        }
      }
    }
    
    return null;
  }
}

// Legacy function for backward compatibility
async function getLeadDetails(leadId, config = null) {
  return getRecordDetails(leadId, 'Leads', config);
}

// DEPRECATED: Use getRecordDetails instead
// Fetch lead details from Zoho with automatic token refresh
async function __deprecated_getLeadDetails(leadId, config = null) {
  if (!config) {
    config = loadZohoConfig();
    if (!config) {
      return null;
    }
  }

  try {
    // Check if token needs refresh
    if (Date.now() >= config.tokenExpiry) {
      const refreshed = await refreshZohoToken(config);
      if (!refreshed) {
        return null;
      }
    }
    
    const response = await axios.get(
      `${config.apiDomain}/crm/v2/Leads/${leadId}`,
      {
        headers: {
          'Authorization': `Zoho-oauthtoken ${config.accessToken}`,
          'Content-Type': 'application/json'
        }
      }
    );
    return response.data;
  } catch (error) {
    // If token is invalid, try refreshing once
    if (error.response?.data?.code === 'INVALID_TOKEN') {
      const refreshed = await refreshZohoToken(config);
      if (refreshed) {
        // Retry the request with new token
        try {
          const response = await axios.get(
            `${config.apiDomain}/crm/v2/Leads/${leadId}`,
            {
              headers: {
                'Authorization': `Zoho-oauthtoken ${config.accessToken}`,
                'Content-Type': 'application/json'
              }
            }
          );
          return response.data;
        } catch (retryError) {
          return null;
        }
      }
    }
    
    return null;
  }
}

// Update Zoho lead with automatic token refresh
async function updateZohoLead(leadId, fieldUpdates, config = null) {
  if (!config) {
    config = loadZohoConfig();
    if (!config) {
      return null;
    }
  }

  try {
    // Check if token needs refresh
    if (Date.now() >= config.tokenExpiry) {
      const refreshed = await refreshZohoToken(config);
      if (!refreshed) {
        return null;
      }
    }
    
    const response = await axios.put(
      `${config.apiDomain}/crm/v2/Leads/${leadId}`,
      {
        data: [fieldUpdates]
      },
      {
        headers: {
          'Authorization': `Zoho-oauthtoken ${config.accessToken}`,
          'Content-Type': 'application/json'
        }
      }
    );
    
    return response.data;
  } catch (error) {
    // If token is invalid, try refreshing once
    if (error.response?.data?.code === 'INVALID_TOKEN') {
      const refreshed = await refreshZohoToken(config);
      if (refreshed) {
        // Retry the request with new token
        try {
          const response = await axios.put(
            `${config.apiDomain}/crm/v2/Leads/${leadId}`,
            {
              data: [fieldUpdates]
            },
            {
              headers: {
                'Authorization': `Zoho-oauthtoken ${config.accessToken}`,
                'Content-Type': 'application/json'
              }
            }
          );
          return response.data;
        } catch (retryError) {
          return null;
        }
      }
    }
    
    return null;
  }
}

// Show only changed fields with filtering
function getChangedFields(leadId, leadData, affectedFieldsArray) {
  if (!affectedFieldsArray || affectedFieldsArray.length === 0) {
    return;
  }
  
  // Find the affected fields for this specific lead ID
  const leadAffectedFields = affectedFieldsArray.find(item => item[leadId]);
  
  if (!leadAffectedFields || !leadAffectedFields[leadId]) {
    return;
  }
  
  const allChangedFields = leadAffectedFields[leadId];
  // Filter out ignored fields
  const changedFieldNames = filterIgnoredFields(allChangedFields, 'zoho');
  
  if (allChangedFields.length !== changedFieldNames.length) {
    const { shouldIgnoreField } = require('../config/config');
    const ignoredFields = allChangedFields.filter(field => shouldIgnoreField(field, 'zoho'));
  }
  
  return {
    changedFields: changedFieldNames,
    allChangedFields: allChangedFields,
    currentValues: changedFieldNames.reduce((acc, field) => {
      acc[field] = leadData[field];
      return acc;
    }, {})
  };
}

// Extract key lead information for logging
function logLeadDetails(lead) {
  // Lead details logged
}

// Fetch leads modified since a specific timestamp
async function getLeadsModifiedSince(sinceTimestamp, config = null) {
  if (!config) {
    config = loadZohoConfig();
    if (!config) {
      return null;
    }
  }

  try {
    // Check if token needs refresh
    if (Date.now() >= config.tokenExpiry) {
      const refreshed = await refreshZohoToken(config);
      if (!refreshed) {
        return null;
      }
    }

    // Format timestamp for Zoho API (ISO format)
    const sinceDate = new Date(sinceTimestamp).toISOString();
    
    const response = await axios.get(
      `${config.apiDomain}/crm/v2/Leads`,
      {
        headers: {
          'Authorization': `Zoho-oauthtoken ${config.accessToken}`,
          'Content-Type': 'application/json'
        },
        params: {
          'sort_by': 'Modified_Time',
          'sort_order': 'desc',
          'page': 1,
          'per_page': 200, // Max records per page
          'fields': 'id,Modified_Time', // We'll fetch full details separately
          'criteria': `(Modified_Time:greater_than:${sinceDate})`
        }
      }
    );

    return response.data;
  } catch (error) {
    // If token is invalid, try refreshing once
    if (error.response?.data?.code === 'INVALID_TOKEN') {
      const refreshed = await refreshZohoToken(config);
      if (refreshed) {
        // Retry the request with new token
        try {
          const sinceDate = new Date(sinceTimestamp).toISOString();
          const response = await axios.get(
            `${config.apiDomain}/crm/v2/Leads`,
            {
              headers: {
                'Authorization': `Zoho-oauthtoken ${config.accessToken}`,
                'Content-Type': 'application/json'
              },
              params: {
                'sort_by': 'Modified_Time',
                'sort_order': 'desc',
                'page': 1,
                'per_page': 200,
                'fields': 'id,Modified_Time',
                'criteria': `(Modified_Time:greater_than:${sinceDate})`
              }
            }
          );
          return response.data;
        } catch (retryError) {
          return null;
        }
      }
    }
    
    return null;
  }
}

// Fetch all fields for multiple leads efficiently
async function getMultipleLeadDetails(leadIds, config = null) {
  if (!config) {
    config = loadZohoConfig();
    if (!config) {
      return null;
    }
  }

  if (!leadIds || leadIds.length === 0) {
    return { data: [] };
  }

  try {
    // Check if token needs refresh
    if (Date.now() >= config.tokenExpiry) {
      const refreshed = await refreshZohoToken(config);
      if (!refreshed) {
        return null;
      }
    }

    // Zoho allows up to 100 IDs per request
    const idsString = leadIds.slice(0, 100).join(',');
    
    const response = await axios.get(
      `${config.apiDomain}/crm/v2/Leads`,
      {
        headers: {
          'Authorization': `Zoho-oauthtoken ${config.accessToken}`,
          'Content-Type': 'application/json'
        },
        params: {
          'ids': idsString
        }
      }
    );

    return response.data;
  } catch (error) {
    // If token is invalid, try refreshing once
    if (error.response?.data?.code === 'INVALID_TOKEN') {
      const refreshed = await refreshZohoToken(config);
      if (refreshed) {
        try {
          const idsString = leadIds.slice(0, 100).join(',');
          const response = await axios.get(
            `${config.apiDomain}/crm/v2/Leads`,
            {
              headers: {
                'Authorization': `Zoho-oauthtoken ${config.accessToken}`,
                'Content-Type': 'application/json'
              },
              params: {
                'ids': idsString
              }
            }
          );
          return response.data;
        } catch (retryError) {
          return null;
        }
      }
    }
    
    return null;
  }
}

// Create Zoho lead
async function createZohoLead(leadData, config = null) {
  if (!config) {
    config = loadZohoConfig();
    if (!config) {
      return null;
    }
  }

  try {
    // Check if token needs refresh
    if (Date.now() >= config.tokenExpiry) {
      const refreshed = await refreshZohoToken(config);
      if (!refreshed) {
        return null;
      }
    }
    
    const response = await axios.post(
      `${config.apiDomain}/crm/v2/Leads`,
      {
        data: [leadData]
      },
      {
        headers: {
          'Authorization': `Zoho-oauthtoken ${config.accessToken}`,
          'Content-Type': 'application/json'
        }
      }
    );
    
    return response.data;
  } catch (error) {
    // If token is invalid, try refreshing once
    if (error.response?.data?.code === 'INVALID_TOKEN') {
      const refreshed = await refreshZohoToken(config);
      if (refreshed) {
        // Retry the request with new token
        try {
          const response = await axios.post(
            `${config.apiDomain}/crm/v2/Leads`,
            {
              data: [leadData]
            },
            {
              headers: {
                'Authorization': `Zoho-oauthtoken ${config.accessToken}`,
                'Content-Type': 'application/json'
              }
            }
          );
          return response.data;
        } catch (retryError) {
          return null;
        }
      }
    }
    
    return null;
  }
}

// Delete a Zoho lead
async function deleteZohoLead(leadId, config = null) {
  if (!config) {
    config = loadZohoConfig();
    if (!config) {
      return false;
    }
  }

  try {
    // Check if token needs refresh
    if (Date.now() >= config.tokenExpiry) {
      const refreshed = await refreshZohoToken(config);
      if (!refreshed) {
        return false;
      }
    }
    
    const response = await axios.delete(
      `${config.apiDomain}/crm/v2/Leads/${leadId}`,
      {
        headers: {
          'Authorization': `Zoho-oauthtoken ${config.accessToken}`,
          'Content-Type': 'application/json'
        }
      }
    );
    
    return response.data?.data?.[0]?.status === 'success';
  } catch (error) {
    // If token is invalid, try refreshing once
    if (error.response?.data?.code === 'INVALID_TOKEN') {
      const refreshed = await refreshZohoToken(config);
      if (refreshed) {
        // Retry the request with new token
        try {
          const response = await axios.delete(
            `${config.apiDomain}/crm/v2/Leads/${leadId}`,
            {
              headers: {
                'Authorization': `Zoho-oauthtoken ${config.accessToken}`,
                'Content-Type': 'application/json'
              }
            }
          );
          return response.data?.data?.[0]?.status === 'success';
        } catch (retryError) {
          return false;
        }
      }
    }
    
    return false;
  }
}

module.exports = {
  refreshZohoToken,
  getLeadDetails,
  updateZohoLead,
  createZohoLead,
  deleteZohoLead,
  getChangedFields,
  logLeadDetails,
  getLeadsModifiedSince,
  getMultipleLeadDetails
};